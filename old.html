<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Results - Placement Test</title>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Azure Speech SDK -->
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

    <script>
        (function() {
            emailjs.init("neXjwiQVXsMwW54x4");
        })();
    </script>

    <style>
        * { box-sizing: border-box; }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: radial-gradient(circle at top left, #18a999 0%, #0a4d43 45%, #052825 100%);
            color: #2d3748;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .quiz-card {
            background: #ffffff;
            border-radius: 18px;
            box-shadow: 0 24px 70px rgba(0, 0, 0, 0.35);
            padding: 40px 32px 32px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .quiz-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(15, 105, 92, 0.12), transparent 55%);
            pointer-events: none;
        }

        .quiz-inner {
            position: relative;
            z-index: 1;
        }

        /* LOGO LAYOUT - UNIFORM HEIGHT FOR BOTH */
        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 10px;
            min-height: 100px;
        }

        /* BOTH LOGOS: FIXED HEIGHT 100PX, AUTO WIDTH */
        .logo-left, .logo-right {
            height: 100px;
            width: auto;
            max-width: 300px;
            object-fit: contain;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.18));
        }

        .header {
            text-align: center;
            margin-bottom: 26px;
        }

        .title {
            font-size: 42px;
            font-weight: 800;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #1a202c;
            margin: 0 0 4px 0;
        }

        .title-sub {
            font-size: 28px;
            font-weight: 700;
            color: #2f855a;
            margin: 0 0 10px 0;
            letter-spacing: 0.03em;
        }

        .subtitle {
            font-size: 18px;
            color: #718096;
            margin: 0;
        }

        .speaking-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .criteria-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .criteria-box h3 {
            color: #856404;
            margin: 0 0 10px 0;
        }

        .speaking-question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f5576c;
        }

        .speaking-question h4 {
            color: #333;
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        .record-btn {
            background: #e74c3c;
            padding: 14px 28px;
            border-radius: 999px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 12px 28px rgba(231, 76, 60, 0.4);
        }

        .record-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 16px 36px rgba(231, 76, 60, 0.5);
        }

        .record-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .record-btn.recording {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }

        .record-btn.analyzing {
            background: #667eea;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .analysis-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .analysis-item {
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 8px;
        }

        .score-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 999px;
            font-weight: 700;
            margin: 5px;
        }

        .score-excellent {
            background: #d4edda;
            color: #155724;
        }

        .score-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .score-fair {
            background: #fff3cd;
            color: #856404;
        }

        .score-needs-improvement {
            background: #f8d7da;
            color: #721c24;
        }

        .transcription-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
        }

        .start-screen {
            text-align: center;
            padding: 28px 0 10px;
        }

        .instructions {
            background: linear-gradient(135deg, #edf2f7 0%, #e2f0f1 100%);
            padding: 18px 20px;
            border-radius: 14px;
            margin-bottom: 26px;
            font-size: 17px;
            color: #4a5568;
            text-align: center;
            border: 1px solid #d3e1e5;
        }

        .start-form {
            max-width: 420px;
            margin: 24px auto 0;
            text-align: left;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 11px 12px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 9px;
            box-sizing: border-box;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #0f695c;
            box-shadow: 0 0 0 2px rgba(15, 105, 92, 0.25);
        }

        .start-button, .submit-button {
            background: linear-gradient(135deg, #0f695c 0%, #0a4d43 100%);
            color: white;
            border: none;
            padding: 16px 46px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 0.18s, box-shadow 0.18s;
            box-shadow: 0 12px 28px rgba(15, 105, 92, 0.45);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .start-button:hover, .submit-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 16px 36px rgba(15, 105, 92, 0.55);
        }

        .submit-button:disabled {
            opacity: 0.65;
            cursor: not-allowed;
            transform: none;
        }

        .quiz-screen {
            margin-top: 8px;
        }

        .quiz-header-bar {
            position: sticky;
            top: 0;
            z-index: 5;
            padding: 10px 0 14px;
            margin-bottom: 14px;
            background: linear-gradient(to bottom, #ffffff 80%, rgba(255, 255, 255, 0.9));
            border-bottom: 1px solid #e2e8f0;
        }

        .quiz-header-main {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
            gap: 14px;
        }

        .quiz-user-info {
            flex: 1 1 200px;
            padding: 10px 14px;
            background: #f7fafc;
            border-radius: 12px;
            border: 1px dashed #cbd5e0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        .quiz-user-info strong {
            font-weight: 700;
            color: #2d3748;
        }

        .dot-separator {
            color: #a0aec0;
            margin: 0 6px;
        }

        .quiz-status {
            flex: 1.3 1 260px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .timer-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .progress-section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 10px 14px 12px;
            border: 1px solid #e2e8f0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            margin-bottom: 6px;
            color: #4a5568;
        }

        .progress-text {
            font-weight: 600;
            color: #2d3748;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e2e8f0;
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, #0f695c, #38b2ac);
            transition: width 0.25s ease-out;
        }

        .question-container {
            margin-bottom: 24px;
            padding: 22px 20px 20px;
            background: #f7fafc;
            border-radius: 14px;
            border-left: 5px solid #0f695c;
        }

        .question-number {
            color: #0f695c;
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .question-text {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 14px;
            line-height: 1.6;
            white-space: pre-line;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.18s ease;
            font-size: 16px;
            color: #2d3748;
        }

        .option:hover {
            border-color: #0f695c;
            background: #edf2f7;
            box-shadow: 0 4px 12px rgba(15, 105, 92, 0.12);
        }

        .option input[type="radio"] {
            margin-right: 12px;
            width: 19px;
            height: 19px;
            cursor: pointer;
            accent-color: #0f695c;
        }

        .option span {
            flex: 1;
        }

        .results-screen {
            text-align: center;
            padding: 30px 0 10px;
        }

        .score-message {
            font-size: 26px;
            color: #1a202c;
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 70px;
            font-weight: 800;
            color: #0f695c;
            margin: 16px 0 8px;
        }

        .performance-badge {
            display: inline-block;
            padding: 13px 34px;
            border-radius: 999px;
            font-size: 20px;
            font-weight: 700;
            margin: 12px 0 8px;
        }

        .level-advanced {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #1a5f3f;
        }

        .level-upper-intermediate {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2c5282;
        }

        .level-intermediate {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #7c2d12;
        }

        .level-pre-intermediate {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #742a2a;
        }

        .level-elementary {
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
            color: #553c9a;
        }

        .time-taken {
            font-size: 17px;
            color: #718096;
            margin-bottom: 18px;
            white-space: pre-line;
        }

        .results-actions {
            margin-top: 12px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }

        .secondary-button {
            border-radius: 999px;
            border: 1px solid #cbd5e0;
            background: #f7fafc;
            padding: 10px 20px;
            font-size: 15px;
            cursor: pointer;
            color: #2d3748;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s ease;
        }

        .secondary-button:hover {
            background: #edf2f7;
            box-shadow: 0 4px 10px rgba(148, 163, 184, 0.35);
            transform: translateY(-1px);
        }

        .success-message {
            background: #f0fdf4;
            border: 2px solid #86efac;
            color: #166534;
            padding: 16px;
            border-radius: 12px;
            margin-top: 18px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid #fc8181;
            color: #c53030;
            padding: 16px;
            border-radius: 12px;
            margin-top: 18px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .warning-message {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            color: #92400e;
            padding: 16px;
            border-radius: 12px;
            margin-top: 18px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, .4);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.9s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .quiz-card {
                padding: 26px 18px 24px;
            }
            .logo-container {
                min-height: 80px;
            }
            .logo-left, .logo-right {
                height: 80px;
                max-width: 240px;
            }
            .title {
                font-size: 32px;
            }
            .title-sub {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="quiz-card">
            <div class="quiz-inner">
                <!-- LOGOS - SAME HEIGHT 100PX -->
                <div class="logo-container">
                    <img class="logo-left" src="https://raw.githubusercontent.com/Abeerahmedwafa123/Mental-Math-/main/Monglish%20Logo.png" alt="Monglish Logo" onerror="this.style.display='none'">
                    <img class="logo-right" src="https://raw.githubusercontent.com/Abeerahmedwafa123/Mental-Math-/main/Edu-Logo%20(1).png" alt="Edulixa Logo" onerror="this.style.display='none'">
                </div>

                <div class="header">
                    <h1 class="title">Business Results</h1>
                    <h2 class="title-sub">Placement Test</h2>
                    <p class="subtitle">Test Your English Language Skills</p>
                </div>

                <div id="login-screen" class="start-screen">
                    <h2 style="color:#1a202c;margin-bottom:10px">üîí Secure Exam Login</h2>
                    <div class="instructions">
                        Enter your <strong>Exam Password</strong> exactly as given by the examiner.<br>
                        Each password can be used <strong>only once</strong>.
                    </div>
                    <form id="login-form" class="start-form" onsubmit="validateLicense(event)">
                        <div class="form-group">
                            <label class="form-label" for="login-password">Exam Password</label>
                            <input id="login-password" type="password" class="form-input" required>
                        </div>
                        <button type="submit" class="start-button">
                            <span>‚ñ∂</span>
                            <span>Unlock Exam</span>
                        </button>
                    </form>
                    <div id="login-error" class="error-message hidden"></div>
                </div>

                <div id="start-screen" class="start-screen hidden">
                    <div class="instructions">
                        Write your name and date, then start the exam. Choose the correct answer for each question.
                    </div>
                    <form id="info-form" class="start-form" onsubmit="startQuiz(event)">
                        <div class="form-group">
                            <label for="student-name" class="form-label">Full Name *</label>
                            <input type="text" id="student-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="test-date" class="form-label">Date *</label>
                            <input type="date" id="test-date" class="form-input" required>
                        </div>
                        <button type="submit" class="start-button">
                            <span>‚ñ∂</span>
                            <span>Start Placement Test</span>
                        </button>
                    </form>
                </div>

                <div id="quiz-screen" class="quiz-screen hidden">
                    <div class="quiz-header-bar">
                        <div class="quiz-header-main">
                            <div class="quiz-user-info">
                                <span><strong>Name:</strong> <span id="header-student-name"></span></span>
                                <span class="dot-separator">‚Ä¢</span>
                                <span><strong>Date:</strong> <span id="header-test-date"></span></span>
                            </div>
                            <div class="quiz-status">
                                <div class="timer-section" id="timer">Time: 00:00</div>
                                <div class="progress-section">
                                    <div class="progress-label">
                                        <span class="progress-text" id="progress-text">Answered: 0 / 60</span>
                                        <span id="progress-percent">0%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progress-fill"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form id="quiz-form"></form>
                    <button class="submit-button" id="submit-button" onclick="submitQuiz(event)">
                        <span>Submit Quiz</span>
                    </button>
                </div>

                <div id="results-screen" class="hidden results-screen">
                    <h2 class="score-message">Your Placement Test Results</h2>
                    <div class="score-display" id="score-display">0/60</div>
                    <div class="performance-badge" id="performance-badge"></div>
                    <div class="time-taken" id="time-taken"></div>
                    <div id="save-status"></div>
                    <div class="results-actions">
                        <button type="button" class="start-button" onclick="proceedToSpeaking()">
                            <span>üé§ Continue to Speaking Test</span>
                        </button>
                        <button type="button" class="secondary-button" onclick="scrollToTopSmooth()">
                            ‚Üë Back to top
                        </button>
                    </div>
                </div>

                <div id="speaking-screen" class="hidden">
                    <h2 class="score-message">üé§ Speaking Assessment</h2>

                    <div class="criteria-box">
                        <h3>üìã Assessment Criteria for Your Level</h3>
                        <p id="speaking-criteria"></p>
                    </div>

                    <div class="speaking-card">
                        <h3 style="margin-bottom: 20px; color: #1a202c;">Your Speaking Questions</h3>
                        <div id="speaking-questions"></div>
                        <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                            <strong>üéôÔ∏è Instructions:</strong>
                            <p style="margin: 10px 0;">Click "Start Recording" and answer each question clearly. Your pronunciation, fluency, and accuracy will be analyzed.</p>
                        </div>
                    </div>

                    <div style="text-align: center; margin: 30px 0;">
                        <button class="record-btn" id="record-btn" onclick="toggleAIRecording()">
                            üéôÔ∏è Start Recording
                        </button>
                        <p id="recording-status" style="margin-top: 10px; color: #666; font-weight: 600;"></p>
                    </div>

                    <div id="transcription-display" class="hidden">
                        <h3 style="color: #1a202c; margin: 20px 0 15px;">üìù Live Transcription</h3>
                        <div id="transcription-text" class="transcription-box">Waiting for speech...</div>
                    </div>

                    <div class="analysis-section" id="analysis-section" style="display: none;">
                        <h3 style="color: #1a202c; margin-bottom: 15px;">üìä Analysis Results</h3>
                        <div id="analysis-content"></div>
                    </div>

                    <button class="submit-button" onclick="submitSpeakingTest()" id="submit-speaking-btn" disabled>
                        <span>üìß Submit Complete Assessment</span>
                    </button>

                    <div id="speaking-status"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const EMAILJS_SERVICE_ID = "service_ku3fqsf";
        const EMAILJS_TEMPLATE_ID = "template_0httu8r";
        const TARGET_EMAIL = "examinersedulixa@outlook.com";
        const AZURE_SPEECH_KEY = "AkynUbcLLna5rphwZ0xO5i68uLxeEzgwFGYVlJY08CO7IIZ3y6BfJQQJ99BKAC5RqLJXJ3w3AAAYACOG1tCk";
        const AZURE_REGION = "westeurope";

        const licensePasswords = [
            "X7P9Q2","T9F3L8","J4Y8M1","Q2Z7B5","H8W3N9",
            "P5R2T6","K9L4V3","C3M7Q8","F6J1Z4","N2B5K9",
            "Z4T8R2","M7X3F6","R5C9P1","L8J2W7","V1P6N3",
            "S9F4K2","Y3Q7M8","W5L9B4","A7D2C6","E3H8T1",
            "G9Q6K5","D4X1N8","U6B7M3","P1R9C4","K8M2W6",
            "Q7L4H1","J5V3T9","B3N8Z2","F9C1L7","X2Y6H4",
            "R7T5K8","W1Q9M4","M6D8P3","T5G2C9","H4R7X1",
            "S9V6L3","C2Z5W8","P8K1J4","N7F3B6","V1X8R2",
            "K4M3Y7","D9H6Q1","J3P8F5","Y7T4W2","F1V9L6",
            "M8C2R3","L6Q7N1","E5K3Z9","B9D4T2","X3G6H8",
            "T7B2W4","A8P5L9","H2C9M6","R1J8Q3","Z6F4N1",
            "C7L3P5","W2M9T7","P5D7X1","G1R6V8","J8B4C2",
            "M6Q1H5","Y3T9K7","S4W2F8","V7L8D1","K2N3P9",
            "B8C6R4","D1Z7M5","E4V9X2","F3H1Q6","P6G8L4",
            "J2T7M8","R9W5K1","H8X3C7","U5L1F2","Q3B7P9",
            "Z4C8R6","W9M2D1","C1F6T8","A7Y3H5","G4N9K2",
            "M5Q2Z7","T8B6L4","D3H7V2","E9P1C6","K7M3X4",
            "L4W8R3","S2T6N9","P9D5F1","B7G4Q8","H3C2M5",
            "V8X7T1","R6F9K4","M4Q1W8","A5H3B7","J9P6L2",
            "C6D4T8","W1M7F3","Y2G5Q9","P8L3C1","X7T9R4"
        ];

        function validateLicense(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const pwd = passwordInput.value.trim();

            errorDiv.classList.add('hidden');
            errorDiv.textContent = '';

            if (!licensePasswords.includes(pwd)) {
                errorDiv.textContent = 'Invalid exam password.';
                errorDiv.classList.remove('hidden');
                return;
            }

            const usedKey = `exam_license_used_${pwd}`;

            if (localStorage.getItem(usedKey) === 'true') {
                errorDiv.textContent = 'This exam password has already been used on this device.';
                errorDiv.classList.remove('hidden');
                return;
            }

            localStorage.setItem(usedKey, 'true');
            window.examPassword = pwd;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const speakingQuestions = {
            'Pre-elementary': ["What's your name?","Which country / Where are you from?","What's your job?","What does your company produce / provide?","What time do you start work? Tell me about your typical day.","When did you join the company?","What project are you working on at the moment?","When is your next holiday? Where are you going to go?","What do you do in your free time?","Tell me about your family / home / interests."],
            'Elementary': ["What's your name?","Which country / Where are you from?","What's your job?","What does your company produce / provide?","What time do you start work? Tell me about your typical day.","When did you join the company?","What project are you working on at the moment?","When is your next holiday? Where are you going to go?","What do you do in your free time?","Tell me about your family / home / interests."],
            'Pre-intermediate': ["Tell me about your educational background.","Describe your current or most recent job in detail.","What are your dreams and ambitions for the future?","Describe a memorable experience from your past.","Tell me about a book or film you enjoyed recently.","What are your hopes for your career?","Explain why you chose your current field of work."],
            'Intermediate': ["Give a short presentation about your company. For example, its history, products, locations, etc.","What have been some of the big changes at your company recently? What have been the results? What's your opinion on the changes?","How has technology changed your life in recent years (at work and at home)? Do you think it's a good thing?","Explain your viewpoint on remote work - what are the advantages and disadvantages?","Describe a complex project you worked on recently."],
            'Upper-intermediate': ["How important are teams where you work? What are some ways to motivate a team?","How much do you deal with people from other countries (give examples)? Do different cultures do business in different ways?","Think of a problem you had to deal with recently. What happened? How did you solve it? Do you think you could have approached it differently?","Describe a complex subject in your field in detail.","Present an argument for and against a current business trend."],
            'Advanced': ["How important are teams where you work? What are some ways to motivate a team?","How much do you deal with people from other countries (give examples)? Do different cultures do business in different ways?","Think of a problem you had to deal with recently. What happened? How did you solve it? Do you think you could have approached it differently?","Present a detailed analysis of current trends in your industry.","Describe a complex business challenge and your strategic approach to solving it.","Discuss the impact of globalization on your field of work.","Analyze the role of innovation in modern business practices."]
        };

        const speakingCriteria = {
            'Pre-elementary': 'I can use simple phrases and sentences to describe where I live and people I know.',
            'Elementary': 'I can use a series of phrases and sentences to describe in simple terms my family and other people, living conditions, my educational background and my present or most recent job.',
            'Pre-intermediate': 'I can connect phrases in a simple way in order to describe experiences and events, my dreams, hopes and ambitions. I can briefly give reasons and explanations for opinions and plans. I can narrate a story or relate the plot of a book or film and describe my reactions.',
            'Intermediate': 'I can present clear, detailed descriptions on a wide range of subjects related to my field of interest. I can explain a viewpoint on a topical issue giving the advantages and disadvantages of various options.',
            'Upper-intermediate': 'I can present clear, detailed descriptions of complex subjects integrating sub-themes, developing particular points and rounding off with an appropriate conclusion. I can present a clear, smoothly-flowing description or argument in a style appropriate to the context.',
            'Advanced': 'I can present a clear, smoothly-flowing description or argument in a style appropriate to the context and with an effective logical structure which helps the recipient to notice and remember significant points.'
        };

        const questions = [
            { question: "My name ___ Richard Smith.", options: ["is", "are", "am"], correct: 0 },
            { question: "I'm from ___.", options: ["Italy", "Italian", "the Italy"], correct: 0 },
            { question: "___ company is Microsoft.", options: ["She", "She's", "Her"], correct: 2 },
            { question: "Person 1: ___ are you?\nPerson 2: Very well, thanks.", options: ["What", "Who", "How"], correct: 2 },
            { question: "BMW ___ cars.", options: ["produces", "provides", "employs"], correct: 0 },
            { question: "We ___ three factories.", options: ["has", "have", "are"], correct: 1 },
            { question: "Person 1: Do you work for an English company?\nPerson 2: No, I ___. It's French.", options: ["do", "doesn't", "don't"], correct: 2 },
            { question: "Person 1: ___ you spell that, please?\nPerson 2: Sure. It's A-L-A-N.", options: ["Can", "Do", "Are"], correct: 0 },
            { question: "There ___ four international airports near London.", options: ["is", "are", "have"], correct: 1 },
            { question: "A: ___ you like a coffee?\nB: Yes, please.", options: ["Do", "Could", "Would"], correct: 2 },
            { question: "I deal ___ customers every day.", options: ["for", "in", "with"], correct: 2 },
            { question: "Can we ___ a meeting?", options: ["available", "appoint", "arrange"], correct: 2 },
            { question: "Our products are ___ than our main competitors.", options: ["cheap", "cheaper", "cheapest"], correct: 1 },
            { question: "We need to ___ a solution to this problem.", options: ["attend", "make", "find"], correct: 2 },
            { question: "What ___ on at the moment?", options: ["are you working", "do you work", "did you work"], correct: 0 },
            { question: "How do you ___ about that idea?", options: ["think", "agree", "feel"], correct: 2 },
            { question: "The plane leaves from ___ eighteen.", options: ["seat", "platform", "gate"], correct: 2 },
            { question: "I have a ___ schedule this week.", options: ["busy", "fast", "time"], correct: 0 },
            { question: "She's ___ you an email.", options: ["sent", "send", "sended"], correct: 0 },
            { question: "I'm ___, but she's not here today.", options: ["sorry", "afraid", "apologize"], correct: 1 },
            { question: "When ___ the company?", options: ["joined you", "did you join", "did you joined"], correct: 1 },
            { question: "Can I ___ an order for 30 chairs?", options: ["place", "buy", "quote"], correct: 0 },
            { question: "First of all, I ___ you a little bit about me.", options: ["tell", "'m going to tell", "'m telling"], correct: 1 },
            { question: "English ___ all over the world.", options: ["speaks", "has spoken", "is spoken"], correct: 2 },
            { question: "Did you ___ the deadline?", options: ["get", "reach", "meet"], correct: 2 },
            { question: "I ___ him here recently.", options: ["didn't see", "haven't seen", "don't see"], correct: 1 },
            { question: "The new system ___ me focus on more important jobs.", options: ["lets", "allows", "gets"], correct: 0 },
            { question: "This website isn't as easy to use ___ the other one.", options: ["as", "than", "more"], correct: 0 },
            { question: "I'll call you back as soon as I ___ something.", options: ["'m hearing", "'ll hear", "hear"], correct: 2 },
            { question: "You ___ press this button. It's dangerous.", options: ["mustn't", "don't have to", "needn't"], correct: 0 },
            { question: "Your visitor ___ for over an hour. He's in your room now.", options: ["is waiting", "has waited", "has been waiting"], correct: 2 },
            { question: "The two companies plan to form a joint ___.", options: ["venture", "alliance", "forces"], correct: 0 },
            { question: "If we changed the colour, we ___ more.", options: ["sell", "'ll sell", "'d sell"], correct: 2 },
            { question: "When they have finished making the first ___, we can do some tests on it.", options: ["breakthrough", "prototype", "invention"], correct: 1 },
            { question: "He ___ to leave the company by his boss.", options: ["'s been asked", "'s asked", "asked"], correct: 0 },
            { question: "I'm surprised he's late. He's normally so ___.", options: ["hard-working", "patient", "punctual"], correct: 2 },
            { question: "Hello, Alison. I ___ the office actually. Can I call you back tomorrow?", options: ["left", "'d just left", "was just leaving"], correct: 2 },
            { question: "___ the delays with the trains, we all still arrived on time.", options: ["Although", "Even though", "Despite"], correct: 2 },
            { question: "My favourite perk in my job is ___.", options: ["my salary", "my company car", "the overtime"], correct: 1 },
            { question: "James is away, ___?", options: ["isn't he", "doesn't he", "is he"], correct: 0 },
            { question: "I seem to have run ___ of money. Can you lend me some?", options: ["out", "low", "ahead"], correct: 0 },
            { question: "If you don't like this idea, then come ___ with something better.", options: ["across", "in", "up"], correct: 2 },
            { question: "___ speak to them about our idea earlier today?", options: ["Were you able to", "Did you succeed in", "Did you manage"], correct: 0 },
            { question: "Our most ___ customer has been with us for over 25 years.", options: ["loyal", "courteous", "attentive"], correct: 0 },
            { question: "Do you know what time ___?", options: ["is it", "it is", "does it"], correct: 1 },
            { question: "Let's ___ up a list of action points.", options: ["take", "draw", "set"], correct: 1 },
            { question: "We have very ___ information about you. Tell us about yourself.", options: ["little", "few", "plenty"], correct: 0 },
            { question: "We've looked at the history, so now let's ___ to our current activities.", options: ["turn on", "notice", "move on"], correct: 2 },
            { question: "Many women feel that they hit a glass ___ on the corporate ladder.", options: ["roof", "attic", "ceiling"], correct: 2 },
            { question: "Today, we need to ___ on a date for the launch and promotion.", options: ["discuss", "meet", "decide"], correct: 2 },
            { question: "What they are asking is ___ ridiculous.", options: ["very", "absolutely", "such"], correct: 1 },
            { question: "There's a real ___ in the market for this kind of service, I think.", options: ["gap", "break", "miss"], correct: 0 },
            { question: "Shirley is very calm and down to ___.", options: ["key", "world", "earth"], correct: 2 },
            { question: "The pros definitely ___ the cons.", options: ["outcome", "outweigh", "outlook"], correct: 1 },
            { question: "I think you should broaden your ___ and look for a new job.", options: ["horizons", "views", "positions"], correct: 0 },
            { question: "If you ___ I'm sure you would have got the job.", options: ["applied", "would apply", "had applied"], correct: 2 },
            { question: "Am I getting my point ___ clearly enough?", options: ["along", "across", "around"], correct: 1 },
            { question: "There isn't a ___ of purpose to the meeting.", options: ["feel", "sense", "reason"], correct: 1 },
            { question: "Let me ___ you in on some of the background.", options: ["fill", "pack", "add"], correct: 0 },
            { question: "It's difficult to ___ what the reaction might be to this proposal.", options: ["weigh", "gauge", "measure"], correct: 1 }
        ];

        let startTime, timerInterval, userAnswers = [], studentName = '', testDate = '', currentScore = 0, currentLevel = '';
        let recognizer = null, fullTranscription = '', azureAnalysisResults = null;

        function startQuiz(event) {
            event.preventDefault();
            studentName = document.getElementById('student-name').value.trim();
            testDate = document.getElementById('test-date').value;
            if (!studentName || !testDate) return;
            document.getElementById('header-student-name').textContent = studentName;
            document.getElementById('header-test-date').textContent = testDate;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestions();
            updateProgress();
            startTimer();
            scrollToTopSmooth();
        }

        function renderQuestions() {
            const form = document.getElementById('quiz-form');
            form.innerHTML = '';
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';
                questionDiv.innerHTML = `
                    <div class="question-number">Question ${index + 1} of ${questions.length}</div>
                    <div class="question-text">${q.question}</div>
                    <div class="options">
                        ${q.options.map((opt, i) => `
                            <label class="option">
                                <input type="radio" name="question${index}" value="${i}" onchange="updateProgress()">
                                <span>${String.fromCharCode(65 + i)}. ${opt}</span>
                            </label>
                        `).join('')}
                    </div>
                `;
                form.appendChild(questionDiv);
            });
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = `Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function updateProgress() {
            let answeredCount = 0;
            questions.forEach((_, index) => {
                if (document.querySelector(`input[name="question${index}"]:checked`)) answeredCount++;
            });
            const total = questions.length;
            const percent = Math.round((answeredCount / total) * 100);
            document.getElementById('progress-text').textContent = `Answered: ${answeredCount} / ${total}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
        }

        async function submitQuiz(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner"></span><span>Submitting...</span>';
            clearInterval(timerInterval);

            let score = 0, answeredCount = 0;
            userAnswers = [];
            questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                const answer = selected ? parseInt(selected.value, 10) : -1;
                userAnswers.push(answer);
                if (selected) {
                    answeredCount++;
                    if (answer === q.correct) score++;
                }
            });

            currentScore = score;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeTaken = `${minutes}:${String(seconds).padStart(2, '0')}`;

            if (score <= 11) currentLevel = 'Pre-elementary';
            else if (score === 12) currentLevel = 'Elementary';
            else if (score >= 13 && score <= 26) currentLevel = 'Pre-intermediate';
            else if (score >= 27 && score <= 40) currentLevel = 'Intermediate';
            else if (score >= 41 && score <= 54) currentLevel = 'Upper-intermediate';
            else currentLevel = 'Advanced';

            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: TARGET_EMAIL, student_name: studentName, test_date: testDate,
                    exam_password: window.examPassword || 'N/A', score: score, level: currentLevel,
                    time_taken: timeTaken, answered_count: answeredCount,
                    speaking_questions: 'Awaiting speaking test', criteria: speakingCriteria[currentLevel],
                    total_recordings: 0, timestamp: new Date().toLocaleString()
                });
                document.getElementById('save-status').innerHTML = '<div class="success-message">‚úÖ Results sent to ' + TARGET_EMAIL + '!</div>';
            } catch (error) {
                document.getElementById('save-status').innerHTML = '<div class="warning-message">‚ö†Ô∏è Error sending email.</div>';
            }

            showResults(score, answeredCount, elapsed);
            submitButton.disabled = false;
            submitButton.innerHTML = '<span>Submit Quiz</span>';
        }

        function showResults(score, answeredCount, elapsed) {
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');
            document.getElementById('score-display').textContent = `${score}/60`;
            document.getElementById('time-taken').textContent = `${studentName}\n${testDate}\n${minutes}:${String(seconds).padStart(2, '0')}\nAnswered: ${answeredCount}/60`;

            const badge = document.getElementById('performance-badge');
            let badgeClass;
            if (score <= 12) badgeClass = 'level-elementary';
            else if (score >= 13 && score <= 26) badgeClass = 'level-pre-intermediate';
            else if (score >= 27 && score <= 40) badgeClass = 'level-intermediate';
            else if (score >= 41 && score <= 54) badgeClass = 'level-upper-intermediate';
            else badgeClass = 'level-advanced';

            badge.textContent = `Exam Result: ${currentLevel}`;
            badge.className = `performance-badge ${badgeClass}`;
            scrollToTopSmooth();
        }

        function proceedToSpeaking() {
            const questions = speakingQuestions[currentLevel];
            const container = document.getElementById('speaking-questions');
            container.innerHTML = questions.map((q, i) => `
                <div class="speaking-question">
                    <h4>Question ${i + 1}</h4>
                    <p>${q}</p>
                </div>
            `).join('');
            document.getElementById('speaking-criteria').textContent = speakingCriteria[currentLevel];
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('speaking-screen').classList.remove('hidden');
            scrollToTopSmooth();
        }

        async function toggleAIRecording() {
            const recordBtn = document.getElementById('record-btn');
            const statusText = document.getElementById('recording-status');

            if (typeof SpeechSDK === 'undefined') {
                statusText.textContent = '‚ùå Speech SDK not loaded. Please refresh.';
                statusText.style.color = '#e74c3c';
                return;
            }

            if (!recognizer) {
                try {
                    const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(AZURE_SPEECH_KEY, AZURE_REGION);
                    speechConfig.speechRecognitionLanguage = 'en-US';
                    const pronunciationConfig = new SpeechSDK.PronunciationAssessmentConfig("", SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark, SpeechSDK.PronunciationAssessmentGranularity.Phoneme, true);
                    const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
                    recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);
                    pronunciationConfig.applyTo(recognizer);

                    fullTranscription = '';
                    azureAnalysisResults = { pronunciationScores: [], accuracyScores: [], fluencyScores: [], completenessScores: [] };
                    document.getElementById('transcription-display').classList.remove('hidden');
                    document.getElementById('transcription-text').textContent = 'Listening...';

                    recognizer.recognizing = (s, e) => {
                        if (e.result.reason === SpeechSDK.ResultReason.RecognizingSpeech) {
                            document.getElementById('transcription-text').textContent = fullTranscription + '\n[Recognizing...] ' + e.result.text;
                        }
                    };

                    recognizer.recognized = (s, e) => {
                        if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                            fullTranscription += e.result.text + ' ';
                            document.getElementById('transcription-text').textContent = fullTranscription;
                            const pronunciationResult = SpeechSDK.PronunciationAssessmentResult.fromResult(e.result);
                            if (pronunciationResult) {
                                azureAnalysisResults.pronunciationScores.push(pronunciationResult.pronunciationScore || 0);
                                azureAnalysisResults.accuracyScores.push(pronunciationResult.accuracyScore || 0);
                                azureAnalysisResults.fluencyScores.push(pronunciationResult.fluencyScore || 0);
                                azureAnalysisResults.completenessScores.push(pronunciationResult.completenessScore || 0);
                            }
                        }
                    };

                    recognizer.startContinuousRecognitionAsync(() => {
                        recordBtn.textContent = '‚èπÔ∏è Stop & Analyze';
                        recordBtn.classList.add('recording');
                        statusText.textContent = 'üî¥ Recording...';
                        statusText.style.color = '#e74c3c';
                    }, (err) => {
                        statusText.textContent = '‚ùå Error: ' + err;
                        statusText.style.color = '#e74c3c';
                    });
                } catch (error) {
                    statusText.textContent = '‚ùå Error: ' + error.message;
                    statusText.style.color = '#e74c3c';
                }
            } else {
                recordBtn.disabled = true;
                recordBtn.classList.remove('recording');
                recordBtn.classList.add('analyzing');
                recordBtn.textContent = 'ü§ñ Analyzing...';
                statusText.textContent = 'ü§ñ Analyzing...';
                statusText.style.color = '#667eea';

                recognizer.stopContinuousRecognitionAsync(() => {
                    displayAIAnalysis();
                    recognizer.close();
                    recognizer = null;
                    recordBtn.disabled = false;
                    recordBtn.classList.remove('analyzing');
                    recordBtn.textContent = '‚úÖ Complete';
                    statusText.textContent = '‚úÖ Analysis complete!';
                    statusText.style.color = '#27ae60';
                    document.getElementById('submit-speaking-btn').disabled = false;
                }, (err) => {
                    statusText.textContent = '‚ùå Error stopping';
                    recordBtn.disabled = false;
                });
            }
        }

        function displayAIAnalysis() {
            const analysisSection = document.getElementById('analysis-section');
            const analysisContent = document.getElementById('analysis-content');
            analysisSection.style.display = 'block';

            if (!azureAnalysisResults || azureAnalysisResults.pronunciationScores.length === 0) {
                analysisContent.innerHTML = '<div class="warning-message">‚ö†Ô∏è No analysis data. Transcription: ' + (fullTranscription || 'None') + '</div>';
                return;
            }

            const avg = (arr) => Math.round(arr.reduce((a, b) => a + b, 0) / arr.length);
            const avgPronunciation = avg(azureAnalysisResults.pronunciationScores);
            const avgAccuracy = avg(azureAnalysisResults.accuracyScores);
            const avgFluency = avg(azureAnalysisResults.fluencyScores);
            const avgCompleteness = avg(azureAnalysisResults.completenessScores);
            const overallScore = Math.round((avgPronunciation + avgAccuracy + avgFluency + avgCompleteness) / 4);
            const getScoreClass = (score) => score >= 90 ? 'score-excellent' : score >= 75 ? 'score-good' : score >= 60 ? 'score-fair' : 'score-needs-improvement';

            analysisContent.innerHTML = `
                <div class="analysis-item" style="text-align:center;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:10px;">
                    <h3 style="margin:0 0 10px 0;color:white;">Overall Score</h3>
                    <div style="font-size:48px;font-weight:800;">${overallScore}/100</div>
                </div>
                <div class="analysis-item"><strong>üó£Ô∏è Pronunciation:</strong> <span class="score-badge ${getScoreClass(avgPronunciation)}">${avgPronunciation}/100</span></div>
                <div class="analysis-item"><strong>üéØ Accuracy:</strong> <span class="score-badge ${getScoreClass(avgAccuracy)}">${avgAccuracy}/100</span></div>
                <div class="analysis-item"><strong>üí¨ Fluency:</strong> <span class="score-badge ${getScoreClass(avgFluency)}">${avgFluency}/100</span></div>
                <div class="analysis-item"><strong>‚úÖ Completeness:</strong> <span class="score-badge ${getScoreClass(avgCompleteness)}">${avgCompleteness}/100</span></div>
                <div class="analysis-item"><strong>üìù Words:</strong> ${fullTranscription.split(' ').filter(w => w.length > 0).length}</div>
                <div class="analysis-item"><strong>üéØ Level:</strong> ${currentLevel}</div>
            `;
        }

        async function submitSpeakingTest() {
            const submitBtn = document.getElementById('submit-speaking-btn');
            const statusDiv = document.getElementById('speaking-status');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span><span>Submitting...</span>';

            try {
                let aiScores = 'No analysis';
                if (azureAnalysisResults && azureAnalysisResults.pronunciationScores.length > 0) {
                    const avg = (arr) => Math.round(arr.reduce((a, b) => a + b, 0) / arr.length);
                    const p = avg(azureAnalysisResults.pronunciationScores);
                    const a = avg(azureAnalysisResults.accuracyScores);
                    const f = avg(azureAnalysisResults.fluencyScores);
                    const c = avg(azureAnalysisResults.completenessScores);
                    const o = Math.round((p + a + f + c) / 4);
                    aiScores = `Overall: ${o}/100\nPronunciation: ${p}/100\nAccuracy: ${a}/100\nFluency: ${f}/100\nCompleteness: ${c}/100\n\nTranscription:\n${fullTranscription}`;
                }

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                    to_email: TARGET_EMAIL, student_name: studentName, test_date: testDate,
                    exam_password: window.examPassword || 'N/A', score: currentScore, level: currentLevel,
                    time_taken: 'See placement test', answered_count: 60,
                    speaking_questions: speakingQuestions[currentLevel].join('\n'),
                    criteria: speakingCriteria[currentLevel] + '\n\n' + aiScores,
                    total_recordings: 1, timestamp: new Date().toLocaleString()
                });

                statusDiv.innerHTML = '<div class="success-message">‚úÖ Complete assessment submitted to ' + TARGET_EMAIL + '</div>';
                submitBtn.innerHTML = '<span>‚úÖ Submitted</span>';
            } catch (error) {
                statusDiv.innerHTML = '<div class="error-message">‚ùå Error submitting</div>';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>üîÑ Try Again</span>';
            }
        }

        function scrollToTopSmooth() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('test-date');
            if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
        });
    </script>
</body>
</html>
